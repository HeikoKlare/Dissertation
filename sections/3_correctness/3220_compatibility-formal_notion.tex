\section{A Formal Notion of Compatibility}
\label{chap:compatibility:formal_notion}

%\begin{copiedFrom}{SoSym MPM4CPS}

\mnote{Formal notion of fine-grained consistency and compatibility}
In this section, we precisely define our yet informally introduced notion of \emph{compatibility}.
%We first discuss properties of transformation networks %in comparison to a single transformation 
%with an intuitive notion of compatibility, based on considerations in existing work.
For that, we use the fine-grained notion of consistency and defining relations as proposed in \autoref{chap:correctness:finegrained}.
We discuss implicit relations, which are induced by a set of consistency relations, such as transitive relations, and,
finally, derive a compatibility notion from the consistency formalization and its pursued perception.
%To distinguish the previously given coarse-grained and the coming fine-grained definition of consistency and consistency relations, we used the \enquote{model-level} prefix in the coarse-grained notion.
The contents of this and the remaining sections of this chapter are mostly, even literally, taken from our published article on proving compatibility~\owncite{klare2020compatibility-report}.

%This serves as our contribution \ref{contrib:formalization}.
%An introduction to properties of transformation networks and especially compatibility of transformations, what compatibility means and how the network influences the possibility to give guarantees regarding compatibility.

%\todoHeiko{Discuss extensional definition of relations / constraints and its relation to intensional definitions}
% \subsection{Properties of Transformation Network}
% \label{sec:compatibility:networkproperties}

% %% Correctness as a property of single, bidirectional transformations
% Keeping pairs of models consistent by means of incremental, bidirectional transformations has been well researched in recent years~\cite{stevens2010sosym, etzlstorfer2013a, cleve2019dagstuhl}.
% A bidirectional transformation consists of a \emph{relation} that specifies which pairs of models are considered consistent and a pair of directional transformations, denoted as \emph{consistency repair routines}, that take one modified and one originally consistent model and deliver a new model that is consistent to the modified one~\cite{stevens2010sosym}.
% Several well-defined properties of such transformations have been identified.
% The essential \emph{correctness} property states that a consistency repair routine delivers a result such that the models are actually consistent according to the defined relation~\cite{stevens2010sosym}.
% Another important property is \emph{hippocraticness}, which states that a consistency repair routine returns the input model if it was already consistent to the modified one~\cite{stevens2010sosym}.

%%
%% Correctness property of transformation networks, not induced by correctness of single transformations
%%
% When we combine several transformations to a network to achieve consistency between multiple models, those properties of the single transformations are still relevant, as each transformations on its own has to be at least correct to work properly in a network of transformations.
% However, correctness of the single transformations does not induce correctness of the transformation network.
% Taking an arbitrary set of correct transformations and executing them one after another does not necessarily constitute a terminating approach that delivers a result, in which all models are consistent according to the relations of the transformations, because the result of one transformation may violate the relation of another.
% It is possible that the approach does either not terminate, because there is a divergence or alternation in values changed or elements created, or terminates in a state that is not consistent regarding the relations of all transformations~\cite{klare2019icmt}.
% %Consider the example of $R_{PE}, R_{PR}, R'_{ER}$ in \autoref{fig:motivational_example}. A transformation network in which each transformation adds the corresponding element for an added element, such as a resident for an added person by the transformation of $R_{PR}$.
% \todoDiss{Readd}
% %Since the execution of one transformation may lead to a violation of the relation of another transformation, executing each transformation only once can easily lead to termination in an inconsistent state.
% %In consequence, transformations have to be executed in a fixed point iteration manner, until all relations are fulfilled.
% The property of a network to always result in a state in which the models are consistent to all relations of the transformations if they are executed in a specific order, can be seen as a \emph{correctness} property for transformation networks.
% In this work, we focus on that correctness property and do not discuss further quality properties of transformation networks, such as \emph{modularity}, \emph{evolvability} and \emph{comprehensibility}~\cite{klare2018docsym}.


%%
%% Correctness considerable at different levels.
%%
% A single transformation can only be incorrect in terms of its repair routines, because there are no restrictions regarding its relation that may prevent the repair routine from being able to produce a correct result.
% In previous work, however, we identified that transformation networks can be incorrect at different levels~\cite{klare2019icmt}.
% Networks can also be incorrect at the level of relations rather than repair routines, because multiple relations can be contradictory, i.e., they can relate elements in different ways such that the relations cannot be fulfilled at the same time.
% \todoDiss{Readd}
%This especially concerns the \emph{modularization level}, which considers correctness of the binary relations of a set of bidirectional transformations describing when a set of models is consistent, and the \emph{operationalization level}, which considers correctness of the consistency repair routines in terms of producing models that are correct regarding the relations of all bidirectional transformations.
%For a single transformation, there are no restrictions regarding its relation that may prevent the repair routines from being able to produce a correct result, thus correctness is only considered at the operationalization level. %The correctness definition of \textcite{stevens2010sosym} for a single transformation only concerns the operationalization level, because a single relation is correct by construction. 
% Considering only a single transformation, its relation is correct by definition, at least if there is no external specification against which the relations have to be correct, thus the definition of \textcite{stevens2010sosym} for correctness only considers the consistency repair routines.
%However, in case of a transformation network, the different relations may be contradictory, i.e., elements are related in a different way such that the relations cannot be fulfilled at the same time.
% In such a case, the consistency repair routines cannot be result in a state that is consistent according to the relations anymore, thus they may not terminate anymore.
%This is due to the fact that several relations can relate the same elements in a different way, such that they cannot be fulfilled at the same time, i.e. that they are contradictory.
%In such a case, the iteration will not terminate.
% We call the relations of such transformations \emph{incompatible}.
%We define this informal notion of compatibility more precisely in the remainder of this section.

%%
%% Compatibility not achievable by construction -> we focus on checking it
%%
% In consequence, compatibility of relations is a necessary prerequisite for consistency repair routines to produce correct results in transformation networks.
% We also found that correctness of the consistency repair routines can already be achieved by construction, whereas compatibility of the relations cannot be achieved by construction but in the best case be checked for a set of relations.
% In this work, we focus on the possibility to check compatibility of the relations of a set of transformations.
% In the following, we therefore precisely define the notion of compatibility of relations, which excludes contradictions in relations that can prevent consistency repair routines from fulfilling the relation.

% \todo{Example!}

%%
%% Tree topology excludes compatibility
%%
%\subsection{Network Topology Impacts}
% Finally, the topology of a transformation network directly influences how prone it is to incompatibilities of its relations.
% Contradictions of consistency relations, as exemplified with the relations $R_{PE}, R_{PR}, R'_{ER}$ in \autoref{fig:prologue:three_persons_example}, can only occur if the same classes are related to each other by different (sequences of) transformations in a different way.
% For example, in \autoref{fig:prologue:three_persons_example}, each combination of two relations puts the same classes into relation as the third one.
%This can also be a the case if a sequence of transformations introduces this relation, like each combination of two relations in \autoref{fig:motivational_example} relates the same classes as the third relation.
% This means that a transformation network, in which each pair of classes is only related by one sequence of transformations, cannot have contradictory relations and is thus inherently compatible.



% \subsection{Consistency by Transformation Networks}

% \begin{itemize}
%     \item Incremental, bidirectional transformations serve as a means for preserving consistency of models by updating one if the other is modified
%     \item Transformations specify the conditions for consistency (consistency relations), as well as how consistency can be restored after modifications (consistency repair)~\cite{stevens2010sosym}
%     \item Consistency between more than two models can be achieved by coupling bidirectional transformations to networks
%     \item Even if the single transformations are correct, i.e. consistency repair produces results that conform to the consistency relations~\cite{stevens2010sosym}, this may not be the case when \emph{independently developed} bidirectional transformations are combined.
%     \item Interoperability problems can occur at the level of consistency relations, i.e. that the relations of the different transformations cannot be fulfilled at the same time, or at the level of consistency repair, i.e. that the repair routines do not terminate in a consistent state or even not at all~\cite{klare2019icmt}
%     \item While \textcite{klare2019icmt} focused on techniques to avoid interoperability issues at the level of consistency repair, in this work we focus on finding interoperability issues of the underlying consistency relations, which we previously defined as \emph{compatibility} issues~\cite{klare2018docsym}.
%     The avoidance of interoperability issues at the relations level is a necessary assumption to avoid issues at the operationalization level.
% \end{itemize}


% \subsection{Network Topology Impacts}

% \begin{itemize}
%     \item Idea: Couple independently developed transformations (refer to running example) to network
%     \item Problem: Trade-off between different properties, depending on the chosen or induced network topology
%     \item Introduce contrary properties \emph{compatibility} and \emph{modularity} (provide only a naive explanation) and shortly refer to evolvability/comprehensibility \cite{klare2018docsym}.
%     \item Explain problems of building tree structures (inherent compatibility) and motivate arbitrary graph structures, providing high modularity, but not giving compatibility guarantees
% \end{itemize}

%\end{copiedFrom} % SoSym MPM4CPS

%%%%%%% MOVED FINE-GRAINED RELATION INTRODUCTION TO CORRECTNESS CHAPTER


%\begin{copiedFrom}{SoSym MPM4CPS}

\subsection{Implicit Consistency Relations}

\mnote{Concatenation of consistency relations}
Considering sets of consistency relations, as they are implicitly defined by the set of transformations in a transformation network, their combination is of especial interest.
Each set of consistency relations defines relations between two sets of classes, but also implies further \emph{transitive} consistency relations.
Having one relation between classes $\class{A}{}$ and $\class{B}{}$ and one between $\class{B}{}$ and $\class{C}{}$ implies an additional relation between $A$ and $C$.
We define a notion for the concatenation of relations that implies such transitive relations, which are supposed to reflect the consistency constraints introduced by the concatenated relations.
This especially means that models should always be consistent to a concatenation of consistency relations if they are consistent to each of the concatenated relations, as otherwise the concatenation would introduce additional consistency constraints.
To achieve this, the following definition makes appropriate restrictions to the derived consistency relation pairs.

\todoLater{Actually, a concatenation may also consider that two or more relations are concatenated to a single one. I.e. CR1 could map something to A and B, and CR2 could map A to something and CR3 could map B to something. Then there could be a combination of all of them. In fact, each pair of consistency relations between the same metamodels can be combined to "larger" relation that then may be concatenated to other relations. Such a pair could even be a pair of a relation with itself, like if a relation maps on element to two of the same class and another relation then maps one element of the class to another. 
In summary, our notion of transitivity has to consider that concatenation may not only be sequences, but acyclic graphs.}

\begin{definition}[Consistency Relations Concatenation] \label{def:relationconcatenation}
    Let $\consistencyrelation{CR}{1}, \consistencyrelation{CR}{2}$ be two consistency relations. Their concatenation $ \consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}$ is defined as follows:
    \begin{align*}
        &
        %\consistencyrelation{CR}{} = 
        \consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2} \equalsperdefinition \setted{\tupled{\conditionelement{c}{l}, \conditionelement{c}{r}} \mid \\
        & \formulaskip 
        \exists %\consistencyrelationpair{cr}{1} = 
        \tupled{\conditionelement{c}{l}, \conditionelement{c}{r,1}} \in \consistencyrelation{CR}{1} : \exists %\consistencyrelationpair{cr}{2} = 
        \tupled{\conditionelement{c}{l,2}, \conditionelement{c}{r}} \in \consistencyrelation{CR}{2} : %\conditionelement{c}{l,1} = \conditionelement{c}{l} \land \conditionelement{c}{r,2} = \conditionelement{c}{r} \\
        %& \formulaskip\formulaskip
        %\land 
        \conditionelement{c}{l,2} \subseteq \conditionelement{c}{r,1}\\
        & \formulaskip
        \land \forall \tupled{\conditionelement{c}{l}, \conditionelement{c}{r,1}'} \in \consistencyrelation{CR}{1} : \exists \tupled{\conditionelement{c}{l,2}', \conditionelement{c}{r,2}'} \in \consistencyrelation{CR}{2} : \conditionelement{c}{l,2}' \subseteq \conditionelement{c}{r,1}'
        }
    \end{align*}
    with $\classtuple{C}{l,\consistencyrelation{CR}{}} = \classtuple{C}{l,\consistencyrelation{CR}{1}}$ and $\classtuple{C}{r,\consistencyrelation{CR}{}} = \classtuple{C}{r,\consistencyrelation{CR}{2}}$
\end{definition}

\mnote{Requirements for concatenation}
The concatenation of two consistency relations contains pairs of object tuples that are related across common elements in the right respectively left side of the consistency relation pairs.
Such a concatenation may be empty.
Two requirements ensure that all models considered consistent to the concatenation are also consistent to the single relations:
First, two consistency relation pairs of $\consistencyrelation{CR}{1}, \consistencyrelation{CR}{2}$ are only combined if the left condition element of the consistency relation pair from $\consistencyrelation{CR}{2}$ is a subset of the right condition element of the consistency relation pair $\tupled{\conditionelement{c}{l}, \conditionelement{c}{r,1}}$ of $\consistencyrelation{CR}{1}$.
Only in that case the existence of the right condition element of the pair of $\consistencyrelation{CR}{1}$ in a model requires the existence of an according condition element in $\consistencyrelation{CR}{2}$.
%For example, if $\consistencyrelation{CR}{1}$ requires for an element $a$ the elements $b$ and $c$ to exist, then $\consistencyrelation{CR}{2}$ must define a relation for a subset of $b$ and $c$, such that it transitively requires the existence of further elements.
Second, it is necessary that for all elements $\conditionelement{c}{r,1}'$ in the right side of $\consistencyrelation{CR}{1}$, which is considered consistent to a condition element $\conditionelement{c}{l}$, there must be a matching condition element, i.e. a subset of $\conditionelement{c}{r,1}'$, in the left condition of $\consistencyrelation{CR}{2}$.
If there was an element $\conditionelement{c}{r,1}'$ in the right side of $\consistencyrelation{CR}{1}$ for which the left side condition of $\consistencyrelation{CR}{2}$ does not contain a subset, the concatenation does not constraint consistency for the existence of $\conditionelement{c}{l}$.
Thus, without these two restrictions the occurrence of $\conditionelement{c}{l}$ in a model tuple would not necessarily impose any consistency requirement by $\consistencyrelation{CR}{2}$.
In the following, we explain these two requirements at an example.

% \begin{figure}
%     \centering
%     \includegraphics[width=\columnwidth]{figures/concatenation_subset.png}
%     \caption{Two consistency relations with $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2} = \emptyset$ and $\consistencyrelation{CR^T}{2} \concat \consistencyrelation{CR^T}{1} \neq \emptyset$}
%     \label{fig:concatenation_subset}
% \end{figure}

% \begin{figure}
%     \centering
%     \includegraphics[width=\columnwidth]{figures/combined_concatenation_example.png}    \caption{Consistency relations $\consistencyrelation{CR}{1}$ and options $\consistencyrelation{CR}{2}, \consistencyrelation{CR'}{2}, \consistencyrelation{CR''}{2}$ with $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2} = \neq \emptyset$, $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR'}{2} = \emptyset$, $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR''}{2} = \emptyset$ and $\consistencyrelation{CR''^T}{2} \concat \consistencyrelation{CR^T}{1} \neq \emptyset$}
%     \label{fig:concatenation_example}
% \end{figure}


\begin{figure}
    \centering
    \begin{subfigure}{\textwidth}
        \centering
        \input{figures/correctness/compatibility/concatenation_example}
    \end{subfigure}

    \vspace{1em}
    \begin{subfigure}{\textwidth}
        \centering
        \input{figures/correctness/compatibility/concatenation_subset_example}
    \end{subfigure}
%    \includegraphics[width=\columnwidth]{figures/consistency_concatenation_example.png} 
    %\includegraphics[width=\columnwidth]{figures/concatenation_subset.png}
    \caption[Examples for consistency relation concatenation]{Two scenarios, each with two consistency relations: 
    Consistency relations $\consistencyrelation{CR}{1}$ and two options $\consistencyrelation{CR}{2}, \consistencyrelation{CR}{2}'$ with $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2} \neq \emptyset$ and $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}' = \emptyset$, and consistency relations $\consistencyrelation{CR}{3}$ and $\consistencyrelation{CR}{4}$ with $\consistencyrelation{CR}{3} \concat \consistencyrelation{CR}{4} = \emptyset$ and $\consistencyrelation{CR}{4}^T \concat \consistencyrelation{CR}{3}^T \neq \emptyset$. Taken from \owncite{klare2020compatibility-report}.}
    \label{fig:compatibility:concatenation_example}
\end{figure}

\begin{example}
\autoref{fig:compatibility:concatenation_example} extends the initial example (\autoref{fig:compatibility:three_persons_example_extended} on page \pageref{fig:compatibility:three_persons_example_extended}) with further classes in the consistency relations, such that they do not only relate single classes to each other.
It defines an address for employees and, in the second example, also a location for the addresses of residents, which are represented in additional classes.
Both examples contain a consistency relation $\consistencyrelation{CR}{1}$ and $\consistencyrelation{CR}{3}$, respectively, between persons and residents, which define that for each person a resident with the same name has to exist.
The examples provide different options for consistency relation between residents (with locations) and employees with addresses ($\consistencyrelation{CR}{2}, \consistencyrelation{CR}{2}', \consistencyrelation{CR}{4}$), which exemplify the necessity for the restrictions in \autoref{def:relationconcatenation}:
\begin{enumerate}
    \item $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}$: 
$\consistencyrelation{CR}{2}$ requires for each resident an employee with the same name and an address with an arbitrary street name.
In consequence, $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}$ defines a relation for each person with an employee having the same name and all addresses with possible street names.
All models that are consistent to the concatenation are also consistent to the single relations.
    \item $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}'$: 
$\consistencyrelation{CR}{2}'$ is similar to $\consistencyrelation{CR}{2}$ but additionally requires that the street of a resident must not be empty. 
In consequence, for a resident with an empty address it is not required that an employee exists.
This results in $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}' = \emptyset$, because for any person there must not be an employee, as the person can be consistent to a resident with an empty street name.
This shows the necessity of the second restriction in the definition. 
    \item $\consistencyrelation{CR}{3} \concat \consistencyrelation{CR}{4}$: 
The concatenation $\consistencyrelation{CR}{3} \concat \consistencyrelation{CR}{4}$ is obviously empty, because $\consistencyrelation{CR}{3}$ requires a resident for each person, but $\consistencyrelation{CR}{4}$ only requires an employee if there is also a location.
Such a location does not necessarily exist if a person %and thus a resident
exists, thus if the models are consistent to $\consistencyrelation{CR}{3}$ and $\consistencyrelation{CR}{4}$ there must not necessarily be an employee for any contained person.
This shows the necessity for the first restriction in \autoref{def:relationconcatenation}, which would require a left condition element from $\consistencyrelation{CR}{4}$ (resident and location) to be a subset of a right condition element in $\consistencyrelation{CR}{3}$ (resident). %, which is never the case. % because of $\consistencyrelation{CR}{4}$ requiring more elements than $\consistencyrelation{CR}{3}$ ensures to exist or a person.
%This shows the necessity of the first restriction in the definition, which requires for all persons that for each consistent resident according to $\consistencyrelation{CR}{3}$, there is also a condition in $\consistencyrelation{CR}{4}$ that requires an employee to exist.
%However, generally speaking, in this case the left condition elements of the second relation are a subset of those of the right side of the first relation, which means that the first relation does never require all elements to exist that are necessary for the second relation to require existence of any further elements.
    \item $\consistencyrelation{CR}{4}^T \concat \consistencyrelation{CR}{3}^T$: 
The concatenation of the transposed relations $\consistencyrelation{CR}{4}^T \concat \consistencyrelation{CR}{3}^T$ is not empty, but actually contains all combinations of each possible employee with all addresses and relates them to a person with the same name.
This is reasonable, because $\consistencyrelation{CR}{4}^T$ requires for all existing employees and addresses that an appropriate resident with the same name %(and also a location)
has to exist, which then requires a person with that name to exist due to $\consistencyrelation{CR}{3}^T$.
The definition does only cover that case due to its first restriction, because $\conditionelement{c}{l,2}$, i.e., the resident related to a person by $\consistencyrelation{CR}{3}^T$ is a subset of $\conditionelement{c}{r,1}$, i.e., a tuple of resident and location.
\end{enumerate}
\end{example}

% The exemplary consistency relation show why it is necessary that the left condition element of the second consistency relation pair needs to be a subset of the right condition element of the first consistency relation pair when concatenating them.
% The concatenation $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}$ is obviously empty, because for each resident a person is required, but for $\consistencyrelation{CR}{2}$ to require an employee, there must always be a location.
% Such an address does not necessarily exist if a resident and thus a person exists, thus if the models are consistent to $\consistencyrelation{CR}{1}$.
% In consequence, there must not always be an employee if a resident exists.
% The concatenation $\consistencyrelation{CR^T}{2} \concat \consistencyrelation{CR^T}{1}$ is not empty, but actually contains all combinations of each possible employee with all addresses and relates them to a resident with the same name.
% This is reasonable, because $\consistencyrelation{CR^T}{2}$ requires for all existing employees and addresses that an appropriate person with the same name (and also a location) have to exist, which then requires a resident to exist due to $\consistencyrelation{CR^T}{1}$.
% The definition does only cover that, because $\conditionelement{c}{l,2}$, i.e. the person related to a resident by $\consistencyrelation{CR^T}{1}$ is a subset of $\conditionelement{c}{r,1}$, i.e. a tuple of person and location.
 
% \begin{figure}
%     \centering
%     \includegraphics[width=\columnwidth]{figures/consistency_concatenation_example.png}
%     \caption{Two consistency relations with two alternatives for $\consistencyrelation{CR}{2}$ with $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2} \neq \emptyset$ and $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR'}{2} = \emptyset$}
%     \label{fig:concatenation_example}
% \end{figure}

% \autoref{fig:concatenation_example} exemplifies the definition of concatenation and the necessity for its restrictions.
% Considering $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}$, this concatenation relates all residents to employees with the same name and all addresses with any names. 
% So each resident is considered consistent to an employee with the same name and the existence of an address with any street name.
% This is reasonable, because $\consistencyrelation{CR}{1}$ requires a person with an arbitrary address to exist for each resident with the same name. Additionally $\consistencyrelation{CR}{2}$ requires an employee with the same name and an appropriate address to exist.
% For any person to which a resident is considered consistent, an appropriate employee and address exist, which are considered consistent, so the concatenation contains those elements, so $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}$ considers all models consistent that are also consistent to the single relations.
% In contrast, $\consistencyrelation{CR'}{2}$ further restricts $\consistencyrelation{CR}{2}$ by requiring that the street name must not be empty. 
% In consequence, persons with an empty street name do not need to have an appropriate employee and address to be considered consistent.
% In consequence, the concatenation $\consistencyrelation{CR}{1} \concat \consistencyrelation{CR'}{2}$ is empty, because a resident does not necessarily require an employee to exist, because if a person with the same name and an empty street name exist, $\consistencyrelation{CR}{1}$ and $\consistencyrelation{CR'}{2}$ do not require an employee exists.
% This motivates the necessity for the last restriction in the definition of concatenation, which requires for all residents that for each consistent person according to $\consistencyrelation{CR}{1}$, there is also a condition in $\consistencyrelation{CR'}{2}$ that requires an employee to exist.

%Requiring that there must only be a partial overlap in the related elements, i.e. $\conditionelement{c}{r,1} \cap \conditionelement{c}{l,2} \neq \emptyset$ would lead to a combined consistency relation $\consistencyrelation{CR}{}$ that restricts consistency in comparison to the combined relations $\consistencyrelation{CR}{1}$ and $\consistencyrelation{CR}{2}$.

%If there is no overlap between two relations, i.e. they have no elements in common that they put into relation, then the concatenation of them is empty by definition.

%\todoLater{Maybe readd overlapping definition}
% To state when consistency relations are overlapping with each other in the sense that they potentially have elements in common, we define when we denote consistency relations as \emph{overlapping}.

% \begin{definition}[Overlapping Consistency Relations]
%     Let $\consistencyrelation{CR}{1}$ and $\consistencyrelation{CR}{2}$ be two consistency relations. We say that:
%     \begin{align*}
%         \formulaskip &
%         \consistencyrelation{CR}{1} \mathtext{is overlapping with} \consistencyrelation{CR}{2} \equivalentperdefinition \\
%         & \formulaskip
%         \exists \class{C}{} \in \classtuple{C}{l,\consistencyrelation{CR}{1}} : \exists \class{C'}{} \in \classtuple{C}{l,\consistencyrelation{CR}{2}} : \class{C}{} \cap \class{C'}{} \neq \emptyset \\
%         & \formulaskip 
%         \land \exists \class{C}{} \in \classtuple{C}{r,\consistencyrelation{CR}{1}} \exists \class{C'}{} \in \classtuple{C}{r,\consistencyrelation{CR}{2}} : \class{C}{} \cap \class{C'}{} \neq \emptyset
%     \end{align*}
% \end{definition}

% \todoHeiko{Overlapping is not needed right now}

% Consistency relation are considered \emph{overlapping}, if they relate classes that have an overlap in their properties in both sides of the relations. 
% \todoHeiko{Add an example for non-trivial overlap here!}

\mnote{Concatenation not restricting consistency}
We can formally show that the defined notion of concatenation does not lead to any restriction of consistency regarding the single relations:

\begin{lemma}[Concatenation Consistency] \label{lemma:concatenationimpliesconsistency}
    Let $\consistencyrelation{CR}{1}, \consistencyrelation{CR}{2}$ be two consistency relations and let $\consistencyrelation{CR}{} = \consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}$ be their concatenation. For all model tuples $\modeltuple{m} \in \metamodeltupleinstanceset{M}$ the following statement holds:
    \begin{align*}
        &
        \modeltuple{m} \consistenttomath \setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR}{2}} \Rightarrow \modeltuple{m} \consistenttomath \consistencyrelation{CR}{}
    \end{align*}
\end{lemma}

\begin{proof}
    For any tuple of models $\modeltuple{m}$ that is consistent to $\consistencyrelation{CR}{1}$ and $\consistencyrelation{CR}{2}$, take a witness structure $\consistencyrelation{W}{1}$ that witnesses consistency of $\modeltuple{m}$ to $\consistencyrelation{CR}{1}$ and $\consistencyrelation{W}{2}$ that witnesses consistency of $\modeltuple{m}$ to $\consistencyrelation{CR}{2}$.
    Now consider the composed witness structure $\consistencyrelation{W}{} = \consistencyrelation{W}{1} \concat \consistencyrelation{W}{2}$.
    We show that $\consistencyrelation{W}{}$ is a valid witness structure for $\consistencyrelation{CR}{}$.

    Let us assume there were $\tupled{\conditionelement{c}{l}, \conditionelement{c}{r}}, \tupled{\conditionelement{c}{l}', \conditionelement{c}{r}'} \in \consistencyrelation{W}{}$ with $\conditionelement{c}{l} = \conditionelement{c}{l}'$ and $\conditionelement{c}{r} \neq \conditionelement{c}{r}'$, such $\consistencyrelation{W}{}$ is not a witness structure for $\consistencyrelation{CR}{}$.
    Per definition, $\conditionelement{c}{l}$ only occurs in one $\tupled{\conditionelement{c}{l}, \conditionelement{c}{r,1}} \in \consistencyrelation{W}{1}$.
    So there must be two consistency relation pairs $\tupled{\conditionelement{c}{l,2}, \conditionelement{c}{r}}, \tupled{\conditionelement{c}{l,2}', \conditionelement{c}{r}'} \in \consistencyrelation{CR}{2}$ with $\conditionelement{c}{l,2} \subseteq \conditionelement{c}{r,1}$ and $\conditionelement{c}{l,2}' \subseteq \conditionelement{c}{r,1}$.
    However, since $\conditionelement{c}{l,2}$ and $\conditionelement{c}{l,2}'$ contain instances of the same classes and are both subsets of the same object tuple $\conditionelement{c}{r,1}$, we have $\conditionelement{c}{l,2} = \conditionelement{c}{l,2}'$.
    So we know that $\consistencyrelation{W}{}$ fulfills the first condition of a witness structure according to \autoref{def:consistency} for consistency:
    \begin{align*}
        &
        \forall \tupled{\conditionelement{c}{l,1}, \conditionelement{c}{r,1}}, \tupled{\conditionelement{c}{l,2}, \conditionelement{c}{r,2}} \in \consistencyrelation{W}{} : %\\
        %& \formulaskip
        \tupled{\conditionelement{c}{l,1}, \conditionelement{c}{r,1}} = \tupled{\conditionelement{c}{l,2}, \conditionelement{c}{r,2}} \lor \conditionelement{c}{l,1} \neq \conditionelement{c}{l,2} \land \conditionelement{c}{r,1} \neq \conditionelement{c}{r,2}
    \end{align*}
    Additionally, since $\consistencyrelation{W}{1}$ and $\consistencyrelation{W}{2}$ are witness structures for consistency of $\modeltuple{m}$ to $\consistencyrelation{CR}{1}$ and $\consistencyrelation{CR}{2}$, the model tuple contains all condition elements in $\consistencyrelation{W}{1}$ and $\consistencyrelation{W}{2}$.
    Consequentially, $\modeltuple{m}$ also contains the condition elements in $\consistencyrelation{W}{}$, as those in $\consistencyrelation{W}{}$ are composed of the ones in $\consistencyrelation{W}{1}$ and $\consistencyrelation{W}{2}$. This implies that the second condition of \autoref{def:consistency} is fulfilled:
    \begin{align*}
        &
        \forall \tupled{\conditionelement{c}{l}, \conditionelement{c}{r}} \in  \consistencyrelation{W}{} : \modeltuple{m} \containsmath \conditionelement{c}{l} \land \modeltuple{m} \containsmath \conditionelement{c}{r}
    \end{align*}
    Finally, let us assume that the third condition of \autoref{def:consistency} is not fulfilled, i.e.: 
    \begin{align*}
        &
        \exists \conditionelement{c}{l}' \in \condition{c}{l,\consistencyrelation{CR}{}} : \modeltuple{m} \containsmath \conditionelement{c}{l}' \land \conditionelement{c}{l}' \not\in \condition{c}{l,\consistencyrelation{W}{}}
    \end{align*}
    We know that $\condition{c}{l,\consistencyrelation{CR}{}} \subseteq \condition{c}{l,\consistencyrelation{CR}{1}}$, because the left condition elements in $\consistencyrelation{CR}{}$ are, per definition, taken from the left condition elements in $\consistencyrelation{CR}{1}$ and thus also contained in $\consistencyrelation{CR}{1}$.
    Since $\modeltuple{m} \containsmath \conditionelement{c}{l}'$, there must be a consistency relation pair $\tupled{\conditionelement{c}{l}', \conditionelement{c}{r,1}'} \in \consistencyrelation{W}{1}$, which witnesses consistency of $\conditionelement{c}{l}'$ according to $\consistencyrelation{CR}{1}$.
    There must be at least one consistency relation pair $\tupled{\conditionelement{c}{l,2}', \conditionelement{c}{r,2}'} \in \consistencyrelation{CR}{2}$ with $\conditionelement{c}{l,2}' \subseteq \conditionelement{c}{r,1}'$, because otherwise $\conditionelement{c}{l}'$ would per definition not occur in the left condition of $\consistencyrelation{CR}{}$.
    For all such tuples $\tupled{\conditionelement{c}{l,2}', \conditionelement{c}{r,2}'}$, we know that $\modeltuple{m} \containsmath \conditionelement{c}{l,2}'$, because $\modeltuple{m} \containsmath \conditionelement{c}{r,1}'$ due to its containment in $\consistencyrelation{W}{1}$ and due to $\conditionelement{c}{l,2}' \subseteq \conditionelement{c}{r,1}'$.
    In consequence, consistency to $\consistencyrelation{CR}{2}$ requires that for one of those $\conditionelement{c}{r,2}'$ it holds that $\modeltuple{m} \containsmath \conditionelement{c}{r,2}'$ and that there is $\tupled{\conditionelement{c}{l,2}', \conditionelement{c}{r,2}'} \in \consistencyrelation{W}{2}$ that witnesses this consistency.
    Summarizing, due to $\tupled{\conditionelement{c}{l}', \conditionelement{c}{r,1}'} \in \consistencyrelation{W}{1}$ and $\tupled{\conditionelement{c}{l,2}', \conditionelement{c}{r,2}'} \in \consistencyrelation{W}{2}$ with $\conditionelement{c}{l,2}' \subseteq \conditionelement{c}{r,1}'$ and due to the definition of $\consistencyrelation{W}{}$ as the concatenation of $\consistencyrelation{W}{1}$ and $\consistencyrelation{W}{2}$, we know that $\tupled{\conditionelement{c}{l}', \conditionelement{c}{r,2}'} \in \consistencyrelation{W}{}$, which breaks our assumption.
    So we have shown that:
    \begin{align*}
        &
        \forall \conditionelement{c}{l}' \in \condition{c}{l,\consistencyrelation{CR}{}} : \modeltuple{m} \containsmath \conditionelement{c}{l}' \Rightarrow \conditionelement{c}{l}' \in \condition{c}{l,\consistencyrelation{W}{}}
    \end{align*}
    Summarizing, we have shown that $\consistencyrelation{W}{}$ fulfills all three requirements for a witness structure according to \autoref{def:consistency} for $\modeltuple{m}$ being consistent to $\consistencyrelation{CR}{}$, so we know that $\modeltuple{m} \consistenttomath \consistencyrelation{CR}{}$.
    % If any set of models $\modelset{m}$ is inconsistent to $\consistencyrelation{CR}{}$, then
    % \begin{align*}
    %     \formulaskip &
    %     \exists \tuple{c}{l} \in \condition{c}{l, \consistencyrelation{CR'}{}} \mid \modelset{m} \mathtext{contains} \conditionelement{c}{l} : \\
    %     & \formulaskip %\label{eq:consistencytransitivenoncontainment}
    %     \forall \conditionelement{c}{r} \in \condition{c}{r, \consistencyrelation{CR'}{}} \mid \tupled{\conditionelement{c}{l}, \conditionelement{c}{r}} \in \consistencyrelation{CR}{} : \neg (\modelset{m} \mathtext{contains} \conditionelement{c}{r}) \\
    %     & \formulaskip %\label{eq:consistencytransitiveduplicatecontainment}
    %     \lor \exists \conditionelement{c'}{r} \in \condition{c}{r, \consistencyrelation{CR'}{}} \setminus \setted{\conditionelement{c}{r}} \mid \tupled{\conditionelement{c}{l}, \conditionelement{c'}{r}} \in \consistencyrelation{CR'}{}: \modelset{m} \mathtext{contains} \conditionelement{c'}{r}
    % \end{align*}
    % \begin{enumerate}
    %     \item Assume that there is no condition element $\conditionelement{c}{r}$, such that $\modelset{m} \containsmath \conditionelement{c}{r}$.
    %     Due to $\consistencyrelation{CR}{}$ being a concatenation of $\consistencyrelation{CR}{1}, \dots, \consistencyrelation{CR}{k}$, for every consistency relation pair $\tupled{\conditionelement{c}{l}, \conditionelement{c}{r}} \in \consistencyrelation{CR}{}$, there is a sequence of consistency relation pairs $\tupled{\conditionelement{c}{l,1}, \conditionelement{c}{r,1}} \in \consistencyrelation{CR}{1}, \dots, \tupled{\conditionelement{c}{l,k}, \conditionelement{c}{r,k}} \in \consistencyrelation{CR}{k}$, such that there is an overlap in the pairs of each sequential consistency relation pair, i.e. $\exists \object{o}{1} \in \conditionelement{c}{r,i}, \object{o}{2} \in \conditionelement{c}{l,i+1} : \object{o}{1} \cap \object{o}{2} \neq \emptyset$.
    %
    %
    %     \item Assume that there are at least two condition elements $\conditionelement{c}{r}, \conditionelement{c'}{r}$, such that $\modelset{m} \containsmath \conditionelement{c}{r}$ and $\modelset{m} \containsmath \conditionelement{c'}{r}$.
    %  
    % \end{enumerate}
    %
    %
    % If any set of models $\modelset{m}$ is consistent to $\setted{\consistencyrelation{CR}{1}, \dots, \consistencyrelation{CR}{k}}$, then
    % \begin{align*}
    %     \formulaskip &
    %     \forall \consistencyrelation{CR'}{} \in \setted{\consistencyrelation{CR}{1}, \dots, \consistencyrelation{CR}{k}} : \\
    %     & \formulaskip 
    %     \forall \tuple{c}{l} \in \condition{c}{l, \consistencyrelation{CR'}{}} \mid \modelset{m} \mathtext{contains} \conditionelement{c}{l} : \exists \conditionelement{c}{r} \in \condition{c}{r, \consistencyrelation{CR'}{}} \mid \tupled{\conditionelement{c}{l}, \conditionelement{c}{r}} \in \consistencyrelation{CR}{} : \\
    %     & \formulaskip\formulaskip 
    %     \modelset{m} \mathtext{contains} \conditionelement{c}{r} \\
    %     & \formulaskip\formulaskip
    %     \land \forall \conditionelement{c'}{r} \in \condition{c}{r, \consistencyrelation{CR'}{}} \setminus \setted{\conditionelement{c}{r}} \mid \tupled{\conditionelement{c}{l}, \conditionelement{c'}{r}} \in \consistencyrelation{CR'}{}: \neg \modelset{m} \mathtext{contains} \conditionelement{c'}{r}
    % \end{align*}
    % This especially holds for all $\conditionelement{c}{l} \in \condition{c}{l,\consistencyrelation{CR}{1}} \mid \modelset{m} \containsmath \conditionelement{c}{l}$.
    % Consider the respective condition elements $\conditionelement{c}{r}$, which $\modelset{m}$ contains as well. If there is a $\conditionelement{c'}{l} \in \condition{c}{l,\consistencyrelation{CR}{2}}$ with $\exists \object{o}{1} \in \conditionelement{c}{r} : \exists \object{o}{2} \in \conditionelement{c'}{l}$ such that $\object{o}{1}$
    % tba \todoHeiko{Add proof}
\end{proof}

% Having shown that our definition of consistency relation concatenation is well-defined in the sense that it does not introduce further restrictions for consistency, we are able to show that the transitive closure of a consistency relation set does also not restrict consistency in comparison to the set of consistency relations itself.


\subsection{Transitive Closure of Consistency Relations}

\mnote{Transitive closure of implicit relations}
Based on the introduced notion of concatenation, we can define a transitive closure for sets of consistency relations, which contains all relations in that set complemented by all possible concatenations of them, i.e., \emph{implicit relations} of that set.
Having shown that our definition of consistency relations concatenation is well-defined in the sense that it does not introduce further restrictions for consistency, we can show that the transitive closure does not restrict consistency in comparison to the set of consistency relation itself.

\begin{definition}[Consistency Relations Transitive Closure] \label{def:transitiveclosure}
    Let $\consistencyrelationset{CR}$ be a set of consistency relations.
    We define its transitive closure $\transitiveclosure{\consistencyrelationset{CR}}$ as:
    \begin{align*}
        \transitiveclosure{\consistencyrelationset{CR}{}} = \setted{\consistencyrelation{CR}{} \mid & \exists \consistencyrelation{CR}{1}, \dots, \consistencyrelation{CR}{k} \in \consistencyrelationset{CR}{} : %\\
        %&
        \consistencyrelation{CR}{} = \consistencyrelation{CR}{1} \concat \dots \concat \consistencyrelation{CR}{k} }
    \end{align*}
\end{definition}

\mnote{Direct and direct relations}
The transitive closure of a set of consistency relations $\consistencyrelationset{CR}$ contains all consistency relations of $\consistencyrelationset{CR}$ and all concatenations of relations in $\consistencyrelationset{CR}$. That means, the transitive closure contains consistency relations that relate all elements that are directly or indirectly related due to $\consistencyrelationset{CR}$.
Due to cycles in the concatenation of relations, this closure can, in general, be of infinite size.

\mnote{Multiple concatenation not restricting consistency}
The transitive closure of a consistency relation set does not further restrict consistency in comparison to the original set by construction of concatenation, i.e., if a model tuple is consistent to a set of consistency relations, it is also consistent to their transitive closure.
We show that in the following by first extending the argument of \autoref{lemma:concatenationimpliesconsistency}, which shows that concatenation does not further restrict consistency, to the transitive closure, which is only a set of concatenations of consistency relations.

\begin{lemma}[Relation Set Consistency]
    Let $\consistencyrelationset{CR}$ be a set of consistency relations for a tuple of metamodels $\metamodeltuple{M}$. Then:
    \begin{align*}
        &
        \forall \consistencyrelation{CR}{} \in \transitiveclosure{\consistencyrelationset{CR}{}} \setminus \consistencyrelationset{CR} :
        \exists \consistencyrelation{CR}{1}, \dots, \consistencyrelation{CR}{k} \in \consistencyrelationset{CR} : \forall \modeltuple{m} \in \metamodeltupleinstanceset{M} : \\
        & \formulaskip
        \modeltuple{m} \consistenttomath \setted{\consistencyrelation{CR}{1}, \dots \consistencyrelation{CR}{k}} \Rightarrow \modeltuple{m} \consistenttomath \consistencyrelation{CR}{} 
    \end{align*}
\end{lemma}

\begin{proof}
    Per definition, any $\consistencyrelation{CR}{} \in \transitiveclosure{\consistencyrelationset{CR}}$ is a concatenation of consistency relations in $\consistencyrelationset{CR}$, i.e.
    \begin{align*}
        &
        \forall \consistencyrelation{CR}{} \in \transitiveclosure{\consistencyrelationset{CR}} : \exists \consistencyrelation{CR}{1}, \dots, \consistencyrelation{CR}{k} \in \consistencyrelationset{CR} : %\\
        %& \formulaskip 
        \consistencyrelation{CR}{} = \consistencyrelation{CR}{1} \concat \dots \concat \consistencyrelation{CR}{k}
    \end{align*}
    We already know for any two consistency relations $\consistencyrelation{CR}{1}, \consistencyrelation{CR}{2}$ and all model tuples $\modeltuple{m}$ that if $\modeltuple{m} \consistenttomath \setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR}{2}}$ then $\modeltuple{m} \consistenttomath \consistencyrelation{CR}{1} \concat \consistencyrelation{CR}{2}$ due to \autoref{lemma:concatenationimpliesconsistency}.
    Inductively applying that argument to $\consistencyrelation{CR}{1}, \dots, \consistencyrelation{CR}{k}$ shows that for all models $\modeltuple{m}$ with $\modeltuple{m} \consistenttomath \setted{\consistencyrelation{CR}{1}, \dots, \consistencyrelation{CR}{k}}$ we know that $\modeltuple{m} \consistenttomath \consistencyrelation{CR}{}$.
\end{proof}

\mnote{Transitive closure not restricting consistency}
As a direct result of the previous lemma, we can now show that the transitive closure of a consistency relation set considers the same tuples of models consistent as the consistency relation set itself.

\begin{lemma}[Transitive Closure Consistency] \label{lemma:consistencytransitiveclosure}
    Let $\consistencyrelationset{CR}$ be a consistency relation set for a metamodel tuple $\metamodeltuple{M}$.
    Then:
    \begin{align*}
        \forall \modeltuple{m} \in \metamodeltupleinstanceset{M}: \modeltuple{m} \consistenttomath \consistencyrelationset{CR} \equivalent
        \modeltuple{m} \consistenttomath \transitiveclosure{\consistencyrelationset{CR}}
    \end{align*}
\end{lemma}

\begin{proof}
    Adding a consistency relation to a set of consistency relations can never lead to a relaxation of consistency, i.e., models becoming consistent that were not considered consistent before. This is a direct consequence of \autoref{def:consistency} for consistency, which requires models be consistent to all consistency relations in a set to be considered consistent, thus only restricting the set of consistent model tuples by adding further consistency relations.
    In consequence, it holds that:
    \begin{align*}
        \modeltuple{m} \consistenttomath \transitiveclosure{\consistencyrelationset{CR}} \Rightarrow \modeltuple{m} \consistenttomath \consistencyrelationset{CR}
    \end{align*}
    According to \autoref{lemma:consistencytransitiveclosure}, a tuple of models that is consistent to $\consistencyrelationset{CR}$ is always consistent to all transitive relations in $\transitiveclosure{\consistencyrelationset{CR}}$ as well. Thus, we know that:
    \begin{align*}
        \modeltuple{m} \consistenttomath \consistencyrelationset{CR} \Rightarrow
        \modeltuple{m} \consistenttomath \transitiveclosure{\consistencyrelationset{CR}}
    \end{align*}
    In consequence, models are considered consistent equally for $\consistencyrelationset{CR}$ and its transitive closure $\transitiveclosure{\consistencyrelationset{CR}}$.
\end{proof}


\subsection{Compatibility of Consistency Relations}

\mnote{Formalization of compatibility}
Based on the notion of fine-grained consistency relations and their concatenation, we can know precisely formulate our initially informal notion of \emph{compatibility} of consistency relations.
We have stated that we consider consistency relation incompatible if they are somehow contradictory, like the relation between names in our initial example in \autoref{fig:compatibility:three_persons_example_extended}.
In that example, for residents with non-lowercase names no consistent tuple of models could be derived.
We formalize this notion of \emph{non-contradictory} relations by requiring that a relation may not restrict that an object tuple, for which consistency is defined in any consistency relation, cannot occur in a model tuple anymore.
%More precisely, we consider relations compatible if for all condition elements in the consistency relations, i.e., for every tuple of objects for which consistency is somehow constrained by requiring further elements to exist in a tuple of models to consider it consistent, a consistent model tuple containing those objects can be found. %In consequence, a consistency relation is not allowed to forbid existence of objects in consistency models for which other relations restrain consistency.

\begin{definition}[Compatibility] \label{def:compatibility}
    Let $\consistencyrelationset{CR}$ be a set of consistency relations for a tuple of metamodels $\metamodeltuple{M}$. % = \setted{\metamodel{M}{1}, \dots \metamodel{M}{k}}$.
    We say that:
    \begin{align*}
        &
        \consistencyrelationset{CR} \compatiblemath \equivalentperdefinition %\\
        %& \formulaskip
        \forall \consistencyrelation{CR}{} \in \consistencyrelationset{CR} : \forall \conditionelement{c}{} \in \condition{c}{l, \consistencyrelation{CR}{}} %\cup \condition{c}{r, \consistencyrelation{CR}{}} 
        : \exists \modeltuple{m} \in \metamodeltupleinstanceset{M} : \\
        & \formulaskip %\formulaskip
        \modeltuple{m} \containsmath \conditionelement{c}{} \land \modeltuple{m} \consistenttomath \consistencyrelationset{CR}
        % \forall \consistencyrelation{CR}{} \in \consistencyrelationset{CR} : \forall %\consistencyrelationpair{cr}{} = 
        % \tupled{\conditionelement{c}{l}, \conditionelement{c}{r}} \in \consistencyrelation{CR}{} : \exists \modelset{m} \in \metamodelinstances{\metamodelset{M}} : \\
        % & \formulaskip \formulaskip
        % \modelset{m} \mathtext{contains} \tupled{\conditionelement{c}{l}, \conditionelement{c}{r}} \land \modelset{m} \mathtext{consistent to} \consistencyrelationset{CR}
    \end{align*}
    We call a set of consistency relation $\consistencyrelationset{CR}$ \emph{incompatible} if it does not fulfill the definition of compatibility.
\end{definition}

%According to that definition, selecting any condition element (i.e. an object tuple) that occurs in the left side of a consistency relation pair, thus requiring another condition element to occur in a set of model to consider it consistent, it must be possible to derive a set of models that contains that object tuple and is considered consistent. 
%\autoref{def:compatibility} formalizes the notion of \emph{non-contradictory} relations by requiring that a relation may not restrict that an object tuple, for which consistency is defined in any consistency relation, cannot occur in a model tuple anymore.
\mnote{Compatibility at running example}
We exemplify this notion of compatibility at an extract of the initial example with different consistency relations.

% According to that definition, selecting any pair of object tuples from any consistency relation, it must be possible to derive a set of models that contains those tuples and is considered consistent. This formalizes the notion of \emph{non-contradictory} relations, as no relation restricts that an element of another relation cannot be fulfilled anymore.

\begin{figure}
    \centering
    \input{figures/correctness/compatibility/compatibility_examples}
    %\includegraphics[width=\columnwidth]{figures/incompatibility_example.png}
    \caption[Different incompatibility scenarios]{Three metamodels with different options of consistency relations. The sets $\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR}{1}^T,\consistencyrelation{CR}{2}, \consistencyrelation{CR}{2}^T, \consistencyrelation{CR}{3}, \consistencyrelation{CR}{3}^T}$ and $\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR}{1}^T, \consistencyrelation{CR}{2}'', \consistencyrelation{CR}{2}''^T, \consistencyrelation{CR}{3}, \consistencyrelation{CR}{3}^T}$ are compatible, whereas the sets $\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR}{1}^T, \consistencyrelation{CR}{2}', \consistencyrelation{CR}{2}'^T, \consistencyrelation{CR}{3}, \consistencyrelation{CR}{3}^T}$ and $\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR}{1}^T, \consistencyrelation{CR}{2}, \consistencyrelation{CR}{2}^T, \consistencyrelation{CR}{3}', \consistencyrelation{CR}{3}'^T}$ are not. Taken from \owncite{klare2020compatibility-report}.}
    \label{fig:compatibility:incompatibility_example}
\end{figure}

\begin{example}
\autoref{fig:compatibility:incompatibility_example} shows an extract of the three metamodels from \autoref{fig:compatibility:three_persons_example_extended} and several consistency relations, of which different combinations are compatible or incompatible according to the previous definition.
We always consider the actual relations together with their transposed ones to have a symmetric set of consistency relations.
% \begin{enumerate}
% \item $\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR^T}{1},\consistencyrelation{CR}{2}, \consistencyrelation{CR^T}{2}, \consistencyrelation{CR}{3}}$:
% These consistency relations are obviously compatible, because they relate $name$ and $firstname$ respectively $lastname$ in the same way. Thus, for any element model element with any name, a consistent model can be found by adding the instances of the other classes with equal names.

% \item $\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR^T}{1},\consistencyrelation{CR'}{2}, \consistencyrelation{CR'^T}{2}, \consistencyrelation{CR}{3}, \consistencyrelation{CR^T}{3}}$:
% These consistency relations are obviously not compatible, because for each person with $firstname$ and $lastname$, another person with $firstname,$ and $lastname$ has to exist due to the transitive relations requiring the addition of a comma. Thus, for each person an infinite number of further persons would have to exist to achieve a consistent set of models. However, models are assumed to be finite, so there is not such set of models and the relations are considered incompatible.

% \item $\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR^T}{1}, \consistencyrelation{CR'}{2}, \consistencyrelation{CR'^T}{2}, \consistencyrelation{CR}{3}, \consistencyrelation{CR^T}{3}}$:
% These consistency relations are compatible, although one might not expect that. The relations define that for a resident with $firstname = f$ and $lastname = l$ another resident with $firstname = l$ and $lastname = f$ has to exist, so that the set of models is consistent.
% Although that behavior may not be intuitive, it does not violate the definition of compatibility, because for any element of the relations, a consistent model can be constructed.
% In general, such a behavior cannot be forbidden, because comparable behavior might be expected, such as that for a software component an implementation class as well a utility class with different names are created due to different relations, which leads to comparable behavior as in the example.
% To detect such a problem, further semantics of properties would have to be considered, as it is necessary to know that a first name should never be mapped to a last name in our example.

% \item $\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR^T}{1}, \consistencyrelation{CR}{2}, \consistencyrelation{CR^T}{2}, \consistencyrelation{CR'}{3}, \consistencyrelation{CR'^T}{3}}$:
% These consistency relations reflect the ones of our motivational example in \autoref{fig:motivational_example}.
% According to the informal notion of incompatibility that we motivated in the introduction with that example, our formal definition of compatibility also considers these relations as incompatible, because it is not possible to create a resident with an uppercase name, so that the containing set of models is consistent.
% For a resident with $name = \mathtext{"A\textvisiblespace B"}$, a person with $firstname = \mathtext{"A"}$ and $lastname = \mathtext{"B"}$ has to exist, which requires existence of an employee with $name = \mathtext{"A\textvisiblespace B"}$. Now $\consistencyrelation{CR'}{3}$ requires a resident with $name = \mathtext{"a\textvisiblespace b"}$ to exist, which in turn requires a resident with $firstname = \mathtext{"a"}$ and $lastname = \mathtext{"b"}$ and an employee with $name = \mathtext{"a\textvisiblespace b"}$ to exist.
% In consequence, there are two employees, one with the uppercase and one with the lowercase name, for which a person with name the lowercase name has to exist according to the relation $\consistencyrelation{CR'}{3}$. So there is no witness structure with a unique mapping between the elements that is required to fulfill the consistency definition.
% \end{enumerate}
\begin{properdescription}
\item[$\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR}{1}^T,\consistencyrelation{CR}{2}, \consistencyrelation{CR}{2}^T, \consistencyrelation{CR}{3}, \consistencyrelation{CR}{3}^T}$:]
These relations are obviously compatible, because they relate $\mathvariable{firstname}$, $\mathvariable{lastname}$ and $\mathvariable{name}$ in the same way. Thus, for each object with any name, and thus any condition element in all of the consistency relations, a consistent model tuple can be found by adding instances of the other classes with appropriate names.

\item[$\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR}{1}^T,\consistencyrelation{CR}{2}', \consistencyrelation{CR}{2}'^T, \consistencyrelation{CR}{3}, \consistencyrelation{CR}{3}^T}$:]
These relations are obviously incompatible, because for each person $\mathvariable{p1}$ with $\mathvariable{p1.firstname}$ and $\mathvariable{p1.lastname}$, another person $\mathvariable{p2}$ with $\mathvariable{p2.firstname} = \mathvariable{p1.firstname} + \textnormal{\enquote{,}}$ and $\mathvariable{p2.lastname} = \mathvariable{p1.lastname}$ has to exist due to $\consistencyrelation{CR}{2}'$ and the transitive relations requiring the addition of a comma. Thus, each person would require an infinite number of further persons to exist in a consistent tuple of models. However, models are assumed to be finite, so there is no such model tuple and the relations are incompatible.

\item[$\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR}{1}^T, \consistencyrelation{CR}{2}', \consistencyrelation{CR}{2}'^T, \consistencyrelation{CR}{3}, \consistencyrelation{CR}{3}^T}$:]
These relations are compatible. The relations define that for a person $\mathvariable{p1}$ with $\mathvariable{p1.firstname}$ and $\mathvariable{p1.lastname}$ another person $\mathvariable{p2}$ with $\mathvariable{p2.firstname} = \mathvariable{p1.lastname}$ and $\mathvariable{p2.lastname} = \mathvariable{p1.firstname}$ has to exist, so that the tuple of models is consistent.
Although that behavior may not be intuitive, it does not violate the definition of compatibility, because for any object in the relations, a consistent model can be constructed.
In general, it can even be necessary that consistency relations require the same elements with swapped attribute values to exist, such that this behavior can and should not be forbidden.
Finally, such a relation would also not prevent a consistency preservation rule from finding a consistent tuple of models.
In consequence, such a behavior may be unwanted in specific situations due to the semantics of the specific domain, like in the example, but it can neither be detected automatically, not does it lead to problems when executing transformations.

\item[$\setted{\consistencyrelation{CR}{1}, \consistencyrelation{CR}{1}^T, \consistencyrelation{CR}{2}, \consistencyrelation{CR}{2}^T, \consistencyrelation{CR}{3}', \consistencyrelation{CR}{3}'^T}$:]
These consistency relations reflect the ones of our motivational example in \autoref{fig:compatibility:three_persons_example_extended}.
According to the informal notion of incompatibility that we have motivated in the introduction with that example, our formal definition of compatibility also considers these relations as incompatible, because it is not possible to create a resident with an uppercase name, such that the containing tuple of models is consistent.
For a resident with $\mathvariable{name} = \textnormal{\enquote{A\textvisiblespace B}}$, a person with $\mathvariable{firstname} = \textnormal{\enquote{A}}$ and $\mathvariable{lastname} = \textnormal{\enquote{B}}$ has to exist, which requires the existence of an employee with $\mathvariable{name} = \textnormal{\enquote{A\textvisiblespace B}}$. Now $\consistencyrelation{CR}{3}'$ requires a resident with $\mathvariable{name} = \textnormal{\enquote{a\textvisiblespace b}}$ to exist, which in turn requires a resident with $\mathvariable{firstname} = \textnormal{\enquote{a}}$ and $\mathvariable{lastname} = \textnormal{\enquote{b}}$ and an employee with $\mathvariable{name} = \textnormal{\enquote{a\textvisiblespace b}}$ to exist.
In consequence, there are two employees, one with the uppercase and one with the lowercase name, for which a resident with the lowercase name has to exist according to the relation $\consistencyrelation{CR}{3}'$. So there is no witness structure with a unique mapping between the elements that is required to fulfill \autoref{def:consistency} for consistency.
\end{properdescription}
\end{example}

\mnote{Goal of compatibility}
To summarize, compatibility is supposed to ensure that consistency relations do not impose restrictions on other relations such that their condition elements, for which consistency is defined, can never occur in consistent models.
The goal of ensuring compatibility of consistency relations is especially to prevent the execution of consistency preservation rules in transformation networks from non-termination, as may occur especially in the second scenario, in which an infinitely large model would be required to fulfill the consistency relations.

\mnote{Equivalence of transitive closure}
Finally, analogously to the equivalence of a set of consistency relations $\consistencyrelationset{CR}$ and its transitive closure $\transitiveclosure{\consistencyrelationset{CR}}$ in regards to consistency of a tuple of models, we can show that a set of consistency relations and its transitive closure are always equal with regards to compatibility.

\begin{lemma}[Transitive Closure Compatibility] \label{lemma:compatibilitytransitiveclosure}
    Let $\consistencyrelationset{CR}$ be a set of consistency relations for a tuple of metamodels $\metamodeltuple{M}$.
    It holds that:
    \begin{align*}
        \consistencyrelationset{CR} \compatiblemath \equivalent
        \transitiveclosure{\consistencyrelationset{CR}} \compatiblemath
    \end{align*}
\end{lemma}

\begin{proof}
    The reverse direction of the equivalence is given by definition, since compatibility of a set of consistency relations implies compatibility of any subset by definition.
    So we have to show the forward direction by considering the compatibility definition for all $\consistencyrelation{CR}{} \in \transitiveclosure{\consistencyrelationset{CR}}$.
    We partition $\transitiveclosure{\consistencyrelationset{CR}}$ into $\consistencyrelationset{CR}$ and $\transitiveclosure{\consistencyrelationset{CR}} \setminus \consistencyrelationset{CR}$ and consider their consistency relations independently.
    
    First, we consider $\consistencyrelation{CR}{} \in \transitiveclosure{\consistencyrelationset{CR}} \setminus \consistencyrelationset{CR}$.
    According to \autoref{def:transitiveclosure} for the transitive closure, each $\consistencyrelation{CR}{} \in \transitiveclosure{\consistencyrelationset{CR}} \setminus \consistencyrelationset{CR}$ is a concatenation of consistency relations $\consistencyrelation{CR}{1}, \dots, \consistencyrelation{CR}{k} \in \consistencyrelationset{CR}$.
    In consequence of that definition, we know that $\condition{c}{l,\consistencyrelation{CR}{}} \subseteq \condition{c}{l,\consistencyrelation{CR}{1}}$, so it is given that:
    \begin{align}
        & \nonumber \label{eq:transitiverelationcontainment}
        \forall \conditionelement{c}{l} \in \condition{c}{l,\consistencyrelation{CR}{}} : \exists \conditionelement{c}{l}' \in \condition{c}{l,\consistencyrelation{CR}{1}} : \forall \modeltuple{m} \in \metamodeltupleinstanceset{M} : \\ 
        & \formulaskip
        \modeltuple{m} \containsmath \conditionelement{c}{l} \Rightarrow \modeltuple{m} \containsmath \conditionelement{c}{l}'
    \end{align}
    Since $\consistencyrelationset{CR}$ is compatible, we especially know from \autoref{def:compatibility} for compatibility that:
    \begin{align}
        & \nonumber \label{eq:compatibilitysingleelement}
        \forall \conditionelement{c}{l}' \in \condition{c}{l, \consistencyrelation{CR}{1}} %\cup \condition{c}{r, \consistencyrelation{CR}{}} 
        : \exists \modeltuple{m} \in \metamodeltupleinstanceset{M} : \\
        & \formulaskip
        \modeltuple{m} \containsmath \conditionelement{c}{l}' \land \modeltuple{m} \consistenttomath \consistencyrelationset{CR}
    \end{align}
    Because of \autoref{eq:transitiverelationcontainment} and \autoref{eq:compatibilitysingleelement}, we know that:
    \begin{align}
        & \nonumber \label{eq:compatibilitysinglelementtransitive}
        \forall \conditionelement{c}{l} \in \condition{c}{l, \consistencyrelation{CR}{}} %\cup \condition{c}{r, \consistencyrelation{CR}{}} 
        : \exists \modeltuple{m} \in \metamodeltupleinstanceset{M} : \\
        & \formulaskip
        \modeltuple{m} \containsmath \conditionelement{c}{l} \land \modeltuple{m} \consistenttomath \consistencyrelationset{CR}
    \end{align}  
    %Due to \autoref{eq:transitiverelationcontainment}, this statement is also true for all $\conditionelement{c}{l} \in \condition{c}{l, \consistencyrelation{CR}{}}$.
    Furthermore, \autoref{lemma:consistencytransitiveclosure} states that:
    \begin{align}
        & \label{eq:consistencytransitiveequal}
        \forall \modeltuple{m} \in \metamodeltupleinstanceset{M}: \modeltuple{m} \consistenttomath \consistencyrelationset{CR} \equivalent \modeltuple{m} \consistenttomath \transitiveclosure{\consistencyrelationset{CR}}
    \end{align}
    In consequence of Equations \ref{eq:compatibilitysinglelementtransitive} and \ref{eq:consistencytransitiveequal}, we know that:
    \begin{align}
        & \nonumber \label{eq:compatibilityonlyclosure}
        \forall \consistencyrelation{CR}{} \in \transitiveclosure{\consistencyrelationset{CR}} \setminus \consistencyrelationset{CR} : \forall \conditionelement{c}{} \in \condition{c}{l, \consistencyrelation{CR}{}} %\cup \condition{c}{r, \consistencyrelation{CR}{}} 
        : \exists \modeltuple{m} \in \metamodeltupleinstanceset{M} : \\
        & \formulaskip
        \modeltuple{m} \containsmath \conditionelement{c}{} \land \modeltuple{m} \consistenttomath \transitiveclosure{\consistencyrelationset{CR}}
    \end{align}
    %
    Second, we consider $\consistencyrelation{CR}{} \in \consistencyrelationset{CR}$.
    Due to compatibility of $\consistencyrelationset{CR}$ and \autoref{lemma:consistencytransitiveclosure} showing equality of consistency of $\modeltuple{m}$ regarding $\consistencyrelationset{CR}$ and $\transitiveclosure{\consistencyrelationset{CR}}$, it is true that:
    \begin{align}
        & \nonumber \label{eq:compatibilitynonclosure}
        \forall \consistencyrelation{CR}{} \in \consistencyrelationset{CR} : \forall \conditionelement{c}{} \in \condition{c}{l, \consistencyrelation{CR}{}} %\cup \condition{c}{r, \consistencyrelation{CR}{}} 
        : \exists \modeltuple{m} \in \metamodeltupleinstanceset{M} : \\
        & \formulaskip
        \modeltuple{m} \containsmath \conditionelement{c}{} \land \modeltuple{m} \consistenttomath \transitiveclosure{\consistencyrelationset{CR}}
    \end{align}
    %
    With \autoref{eq:compatibilityonlyclosure} and \autoref{eq:compatibilitynonclosure}, we have shown compatibility of $\transitiveclosure{\consistencyrelationset{CR}}$ if $\consistencyrelationset{CR}$ is compatible.
\end{proof}

% \begin{figure}
%     \centering
%     \includegraphics[width=0.7\columnwidth]{figures/incompatible_constraints.png}
%     \caption{Three metamodels and three consistency relations relating those elements that have the same valid $i$ ($C1$ and $C2$ resp. $C1$ and $C3$) or a $i$ value differing by $1$ ($C2$ and $C3$)}
%     \label{fig:incompatible_constraints}
% \end{figure}

% \begin{example}
%     Consider the three metamodels in \autoref{fig:incompatible_constraints}, each containing one class with one attribute $i$. They are related by three consistency relations specifying that in two cases objects having the same $i$ are in the consistency relations, whereas in one case two objects with and $i$ differing by $1$ are in the consistency relation. For any of the consistency relation pairs there are not finite models that are consistency to the consistency relations. Such a model would have to be infinite, as it needed to contain the infinite number of objects with all values of $i$.
%     In consequence, those consistency relations would be considered \emph{incompatible} according to \ref{def:compatibility}.
% \end{example}

% \begin{definition}[Strong Compatibility]
%     Let $\set{\consistencyrelation{CR}}$ be a set of consistency relations for metamodels $\metamodel[1]{M}, \ldots, \metamodel[k]{M}$.
%     A consistency relation $\consistencyrelation{CR}{}$ is considered \emph{strongly compatible with} $\set{\consistencyrelation{CR}{}}$ iff
%     \begin{align*}
%         \formulaskip
%         & 
%         \forall \tupled{\model[1]{m}, \ldots, \model[k]{m}} \in \metamodelinstances{\metamodel[1]{M}} \times \dots \times \metamodelinstances{\metamodel[k]{M}} : \\
%         & 
%     \end{align*}
% \end{definition}


% \begin{definition}[Weak Compatibility]
%     Let $\set{\consistencyrelation{CR}}$ be a set of consistency relations for metamodels $\metamodel[1]{M}, \ldots, \metamodel[k]{M}$.
%     A consistency relation $\consistencyrelation{CR}$ is considered \emph{compatible with} $\set{\consistencyrelation{CR}}$ iff
%     \begin{align*}
%         \formulaskip
%         & 
%         \exists \tupled{\tupled{e_{l1}, \ldots, e_{ln}}, \tupled{e_{r1}, \ldots, e_{rm}}} \in \consistencyrelation{CR} : \\
%         & 
%         \exists \tupled{\model[1]{m}, \ldots, \model[k]{m}} \in \metamodelinstances{\metamodel[1]{M}} \times \dots \times \metamodelinstances{\metamodel[k]{M}} : \exists i, j \in \{1, \ldots, k \} : \\
%         & \formulaskip 
%         \{ e_{l1}, \ldots, e_{ln} \} \subseteq \model[i]{m} \land \{ e_{r1}, \ldots, e_{rm} \} \subseteq \model[j]{m} \\
%         & \formulaskip\formulaskip
%         \land \{ \model[1]{m}, \ldots, \model[k]{m} \} \; \text{consistent according to} \; \set{\consistencyrelation{CR}}
%     \end{align*}
% \end{definition}

% This means that a consistency relation is considered compatible with a set of other consistency relations if there is at least one entry of the consistency relation, i.e. a pair of element tuples, which co-occurs in any set of models such that the models are consistent according to the other consistency relations as well.
% If there is no such set of models, which contains one entry of the consistency relation and is consistent according to the other consistency relations, the consistency relations can never be fulfilled altogether, so the consistency relation is considered \emph{incompatible}.

% \begin{definition}[Possibly well-defined Consistency Relations]
%     A set of consistency relations $\set{\consistencyrelation{CR}}$ is considered \emph{possibly well-defined} iff 
%     \begin{align*}
%         \formulaskip
%         & 
%         \forall \consistencyrelation{CR} \in \set{\consistencyrelation{CR}}: \consistencyrelation{CR} \; \text{is compatible with} \; \set{\consistencyrelation{CR}} \setminus \{ \consistencyrelation{CR} \}
%     \end{align*}
% \end{definition}

%\begin{itemize}
%    \item Insight: Compatibility is a mandatory requirement for interoperability of transformations. If they are not compatible, consistency repair will not be able to find a set of consistent models after certain modifications, because the consistency relations do not do not specify appropriate sets of consistent models.
    %\item TODO: Discuss valid models, why we do not consider them and prove that invariants + consistency relations can express any consistency relation.
%\end{itemize}

%\end{copiedFrom} % SoSym MPM4CPS

