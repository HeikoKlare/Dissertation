\newcommand{\modeltypesize}{3.6em}
\newcommand{\modelsize}{0.3em}

\begin{tikzpicture}[
    model type/.style={draw, circle, minimum width=\modeltypesize},
    model/.style={draw, fill, circle, minimum width=\modelsize, inner sep=0},
    label distance=-0.2em,
    every label/.append style={font=\small},
    legend/.style={font=\footnotesize},
    mininode/.style={inner sep=.25em},
]

\foreach \level in {1,2,3} {
    \node[model type, label=265:{$\mathcal{M}_1$}] at (\level*3.45*\modeltypesize, 0) (L\level_MM1) {};
    \node[model, above left=0.25*\modeltypesize and 0.2*\modeltypesize of L\level_MM1.center, anchor=center] (L\level_MM1_M1) {};
    \node[model, right=0.3*\modeltypesize of L\level_MM1.center, anchor=center] (L\level_MM1_M2) {};
    \node[model, below left=0.25*\modeltypesize and 0.2*\modeltypesize of L\level_MM1.center, anchor=center] (L\level_MM1_M3) {};
    
    \node[model type, label=280:{$\mathcal{M}_2$}] at (\level*3.45*\modeltypesize+1.7*\modeltypesize, 0) (L\level_MM2) {};
    \node[model, above right=0.25*\modeltypesize and 0.2*\modeltypesize of L\level_MM2.center, anchor=center] (L\level_MM2_M1) {};
    \node[model, left=0.3*\modeltypesize of L\level_MM2.center, anchor=center] (L\level_MM2_M2) {};
    \node[model, below right=0.25*\modeltypesize and 0.2*\modeltypesize of L\level_MM2.center, anchor=center] (L\level_MM2_M3) {};
    
    \node[model type, label=190:{$\mathcal{M}_3$}] at (\level*3.45*\modeltypesize+0.85*\modeltypesize, -1.35*\modeltypesize) (L\level_MM3) {};
    \node[model, above=0.25*\modeltypesize of L\level_MM3.center, anchor=center] (L\level_MM3_M1) {};
    \node[model, below left=0.25*\modeltypesize and 0.1*\modeltypesize of L\level_MM3.center, anchor=center] (L\level_MM3_M2) {};
    \node[model, below right=0.05*\modeltypesize and 0.25*\modeltypesize of L\level_MM3.center, anchor=center] (L\level_MM3_M3) {};
}

% CONSISTENCY L1
\draw[consistencyrel] (L1_MM1_M1) -- (L1_MM2_M1);
\draw[consistencyrel] ($(L1_MM1_M1)!0.13!(L1_MM2_M1)$) -- (L1_MM3_M2);
\draw[consistencyrel] (L1_MM1_M2) -- (L1_MM2_M2);
\draw[consistencyrel] ($(L1_MM1_M2)!0.5!(L1_MM2_M2)$) -- (L1_MM3_M1);

% CONSISTENCY L2
\draw[consistencyrel] (L2_MM1_M1) -- (L2_MM2_M1);
\draw[consistencyrel] (L2_MM1_M1) -- (L2_MM3_M2);
\draw[consistencyrel] (L2_MM2_M1) -- (L2_MM3_M2);
\draw[consistencyrel] (L2_MM1_M2) -- (L2_MM2_M2);
\draw[consistencyrel] (L2_MM1_M2) -- (L2_MM3_M1);
\draw[consistencyrel] (L2_MM2_M2) -- (L2_MM3_M1);

% CONSISTENCY L3
%\draw[consistency relation] (L3_MM1_M1) -- (L3_MM2_M1);
%\draw[consistency relation] (L3_MM1_M1) -- (L3_MM3_M2);
%\draw[consistency relation] (L3_MM2_M1) -- (L3_MM3_M2);
%\draw[consistency relation] (L3_MM1_M2) -- (L3_MM2_M2);
%\draw[consistency relation] (L3_MM1_M2) -- (L3_MM3_M1);
%\draw[consistency relation] (L3_MM2_M2) -- (L3_MM3_M1);

% USER CHANGE L3
\node[model, user changed element, above left=0.25*\modeltypesize and 0.2*\modeltypesize of L3_MM1.center, anchor=center] (L3_MM1_M1) {};
\node[model, user changed element, above right=0.25*\modeltypesize and 0.2*\modeltypesize of L3_MM2.center, anchor=center] (L3_MM2_M1) {};
\node[model, user changed element, below left=0.25*\modeltypesize and 0.1*\modeltypesize of L3_MM3.center, anchor=center] (L3_MM3_M2) {};
\draw[-latex, user changed element] (L3_MM1_M1) -- node[legend, above=0.2em] {$\Delta$} (L3_MM1_M2);

% CONSISTENCY PRESERVATION L3
\node[model, consistency changed element, right=0.3*\modeltypesize of L3_MM1.center, anchor=center] (L3_MM1_M2) {};
\node[model, consistency changed element, left=0.3*\modeltypesize of L3_MM2.center, anchor=center] (L3_MM2_M2) {};
\node[model, consistency changed element, above=0.25*\modeltypesize of L3_MM3.center, anchor=center] (L3_MM3_M1) {};
\draw[-latex, consistency changed element] (L3_MM2_M1) -- node[legend, below right=-0.3em] {$\Delta$} (L3_MM2_M2);
\draw[-latex, consistency changed element] (L3_MM3_M2) -- node[legend, below right=0 and -0.3em] {$\Delta$} (L3_MM3_M1);
\draw[-latex, dashed, consistency changed element, thin] ($(L3_MM1_M1)!0.4!(L3_MM1_M2)$) to[bend left=15] node[legend, above] {$\mathit{CPS}_{\mathit{CS}_{1,2}}$} ($(L3_MM2_M1)!0.4!(L3_MM2_M2)$);
\draw[-latex, dashed, consistency changed element, very thin] ($(L3_MM1_M1)!0.4!(L3_MM1_M2)$) to[bend right=15] node[legend, below left=0.5em and -0.5em] {$\mathit{CPS}_{\mathit{CS}_{1,3}}$} ($(L3_MM3_M2)!0.4!(L3_MM3_M1)$);

% CS LABELS
\node[consistency related element, above left=1.5em and -0.1em of L1_MM3.north, anchor=east, font=\footnotesize] {$\mathit{CS}$};
\node[consistency related element, above left=0.1em and 1.6em of L2_MM3, anchor=center, font=\footnotesize] {$\mathit{CS}_{1,3}$};
\node[consistency related element, above right=0.4em and 1.2em of L2_MM3, anchor=center, font=\footnotesize] {$\mathit{CS}_{2,3}$};
\node[consistency related element, above right=0.8em and 0.25*\modeltypesize of L2_MM1.east, anchor=south, font=\footnotesize] {$\mathit{CS}_{1,2}$};
%\node[consistency related element, above left=0.4em and 1.8em of L3_MM3, anchor=center, font=\footnotesize] {$CS_{1,3}$};
%\node[consistency related element, above right=0.4em and 1.4em of L3_MM3, anchor=center, font=\footnotesize] {$CS_{2,3}$};
%\node[consistency related element, above right=0.8em and 0.25*\modeltypesize of L3_MM1.east, anchor=south, font=\footnotesize] {$CS_{1,2}$};

% LEVEL LABELS
\node[anchor=north] (level1_label) at ([yshift=1.15*\modeltypesize]$(L1_MM1)!0.5!(L1_MM2)$) {Level 1: \emph{Global}};
\node[anchor=north] (level2_label) at ([yshift=1.15*\modeltypesize]$(L2_MM1)!0.5!(L2_MM2)$) {Level 2: \emph{Modularization}};
\node[anchor=north] (level3_label) at ([yshift=1.15*\modeltypesize]$(L3_MM1)!0.5!(L3_MM2)$) {Level 3: \emph{Operationalization}};

\coordinate (legend_anchor) at ([yshift=-0.2*\modeltypesize]L2_MM3.south);

\node[matrix, left=-0.2em of legend_anchor, anchor=north east, outer sep=0em, column sep=0.15em, row sep=-0.4em] (legend_left) {
    \node[model, anchor=center] (model_legend) {}; &
    \node[legend, anchor=west] {model of model type $\mathcal{M}_x$}; \\
    %
    \node[model, user changed element, anchor=center] (user_changed_model_legend)  {}; &
    \node[legend, anchor=west] {consistent models before user change}; \\
    %
    \node[model, consistency changed element, anchor=center] (consistency_preserved_model_legend)  {}; &
    \node[legend, anchor=west] {consistent models after consistency preservation}; \\
};

\node[matrix, left=0.2em of legend_anchor, anchor=north west, column sep=0.15em, row sep=-0.4em] (legend_right) {
    \draw[consistencyrel] (0,0.25em) -- (1em,0.25em);
    \draw[consistencyrel] (0.5em,0.25em) -- (0.5em,-0.2em); &
    \node[legend, consistency related element, anchor=west] {element of consistency specification}; \\% $\mathit{CS}$}; \\
    % 
    \draw[-latex, user changed element] (0,0) -- (1em,0); &
    \node[legend, user changed element, anchor=west] {user change introducing inconsistency}; \\
    %
    \draw[-latex, consistency changed element] (0,0) -- (1em,0); &
    \node[legend, consistency changed element, anchor=west, align=left] {execution of consistency preservation specification};\\ % $\mathit{CPS}_{\mathit{CS}}$}; \\
};
\coordinate (legend_left_dummy) at ([xshift=-0.3em]legend_left.west);
\node[draw=darkgray, inner sep=0em, fit=(legend_left_dummy)(legend_left)(legend_right)] {};


% \node[model] at (legend_anchor)(model_legend) {};
% \node[legend, right=0 of model_legend] {model of model type $\mathcal{M}_x$};
% \node[model, user changed element, below=1em of model_legend.center, anchor=center] (user_changed_model_legend)  {};
% \node[legend, right=0 of user_changed_model_legend] {consistent models before user change};
% \node[model, consistency changed element, below=1em of user_changed_model_legend.center, anchor=center]     (consistency_preserved_model_legend)  {};
% \node[legend, right=0 of consistency_preserved_model_legend] {consistent models after consistency preservation};
% %
% \draw[consistency relation] ([yshift=0.25em, xshift=20em]legend_anchor) -- ([yshift=0.25em, xshift=21em]legend_anchor);
% \draw[consistency relation] ([yshift=0.25em, xshift=20.5em]legend_anchor) -- ([yshift=-0.25em, xshift=20.5em]legend_anchor);
% \node[legend, consistency related element, anchor=west] at ([xshift=21em]legend_anchor) {element of consistency specification $CS$};
% %
% \draw[-latex, user changed element] ([yshift=-1em, xshift=20em]legend_anchor) -- ([yshift=-1em, xshift=21em]legend_anchor);
% \node[legend, user changed element, anchor=west] at ([yshift=-1em, xshift=21em]legend_anchor) {user change introducing inconsistency};
% %
% \draw[-latex, consistency changed element] ([yshift=-2em, xshift=20em]legend_anchor) -- ([yshift=-2em, xshift=21em]legend_anchor);
% \node[legend, consistency changed element, anchor=north west, align=left] at ([yshift=-1.2em, xshift=21em]legend_anchor) {execution of consistency preservation\\ specification $CPS_{CS}$};

\end{tikzpicture}
