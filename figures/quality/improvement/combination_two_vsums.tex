% requires tikzvitruvius.sty
\begin{tikzpicture}[
    vtcaption/.style={font=\small},
    view/.style={uml box, densely dashed},
    viewtype/.style={circle, draw, solid, fill=white, inner sep=.1em, font=\scriptsize},
    polarrow/.style={latex-latex, densely dotted},
    mininode/.style={inner sep=.4em},
]

% V-SUM 1
\node[uml small box] (oo) {OOD};
\node[uml small box] (uml) [below left=4em and 0.6em of oo] {UML};
\node[uml small box] (java) [below right=4em and 0.6em of oo] {Java};

\node[circle,draw,thick,fit=(oo.center)(uml)(java),inner sep=2ex] (sum1) {};

\draw[manifests relation] (oo) -- node[manifests relation, above, sloped] (pcmJavaCCR) {\manifestslabel} (uml.north);
\draw[manifests relation] (oo) -- node[manifests relation, above, sloped] (pcmJavaCCR) {\manifestslabel} (java.north);

\node[viewtype] (viewtypeOO) at (sum1.40) {$\mathvariable{VT}_\mathvariable{OOD}$};
\node[viewtype] (viewtypeJava) at (sum1.5) {$\mathvariable{VT}_\mathvariable{Java}$};
\draw[polarrow] (oo) -- (viewtypeOO);
\draw[polarrow] (java) -- (viewtypeJava);

\node[font=\bfseries\footnotesize] (sum1text) [above=0.6em of sum1.270, anchor=south, align=center] {\vsum\\ Metamodel};

% V-SUM 2
\node[uml small box] (cbd) [right=14.7em of oo] {CBD};
\node[uml small box] (pcm) [below left=4em and 0.6em of cbd] {PCM};
\node[uml small box] (umlcomp) [below right=4em and 0.6em of cbd] {UML};

\node[circle,draw,thick,fit=(cbd.center)(pcm)(umlcomp),inner sep=2ex] (sum2) {};

\draw[manifests relation] (cbd) -- node[manifests relation, above, sloped] (pcmJavaCCR) {\manifestslabel} (pcm.north);
\draw[manifests relation] (cbd) -- node[manifests relation, above, sloped] (pcmJavaCCR) {\manifestslabel} (umlcomp.north);

\node[viewtype] (viewtypeStruc) at (sum2.140) {$\mathvariable{VT}_\mathvariable{Structure}$};
\node[viewtype] (viewtypeBehav) at (sum2.175) {$\mathvariable{VT}_\mathvariable{Behavior}$};
\draw[polarrow] (cbd) -- (viewtypeStruc);
\draw[polarrow] (pcm.north west) -- (viewtypeBehav);

\node[font=\bfseries\footnotesize] (sum2text) [above=0.6em of sum2.270, anchor=south, align=center] {\vsum\\ Metamodel};

% Outer transformations
\draw[transformation] (viewtypeOO) -- (viewtypeStruc);
\draw[transformation] (viewtypeJava) -- (viewtypeBehav);

\coordinate (middle) at ($(oo)!0.5!(cbd)$);

% Legend
\node[draw, legendbg, matrix, font=\scriptsize, inner sep=0.7em, nodes=mininode, anchor=north, below=10.5em of middle] (legend) {%
    \node[uml small box, minimum height=0.1em, inner sep=0.3em, yshift=0.5ex, font=\scriptsize, anchor=center] (legend_mm) {MM}; & \node[anchor=base west, font=\footnotesize] {Metamodel \hspace{0.5em}\sameheight}; &
    \draw[polarrow] (0em,0.5ex)--(2em,0.5ex); & \node[anchor=base west, font=\footnotesize] {View Transformation\sameheight}; \\
    \node[viewtype, anchor=center, yshift=0.5ex, font=\scriptsize] {$\mathvariable{VT}$}; & \node[anchor=base west, font=\footnotesize] {\ViewType\sameheight};&
    \draw[transformation] (0em,0.5ex)--(2em,0.5ex); & \node[anchor=base west, font=\footnotesize] {Transformation\sameheight};\\
};

\foreach \x in {oo,uml,java,cbd,pcm,umlcomp,legend_mm} {
    \draw (\x.north west) ++ (.2pt,0) -- ++ (0,.2em) -- ++ (0.6em,0) -- ++ (0,-.2em);
}

\end{tikzpicture}
