\newcommand{\vdistance}{13.8em}
\newcommand{\hdistance}{(\vdistance+0.4*\difftoafiveimage)}
\newcommand{\classwidth}{2em}

\begin{tikzpicture}

\umlclassvarwidth{A}{}{A}{
n
}{\classwidth}
\umlclassvarwidth[, right=\hdistance of A.north, anchor=north]{B}{}{B}{
n
}{\classwidth}
\umlclassvarwidth[, right=\hdistance of B.north, anchor=north]{C}{}{C}{
n
}{\classwidth}
\umlclassvarwidth[, above=0.5*\vdistance of B.north, anchor=north]{D}{}{D}{
n
}{\classwidth}

\draw[consistency relation]
    ([yshift=0.7em]A.east)
    --
    node[pos=0, below right] {$a$}
    node[pos=1, below left] {$b$}
    node[above, align=center] {$\consistencyrelation{CR}{AB} = \{\tupled{a,b} \mid a.n, b.n \geq 0$ \\ 
    $\land \; b.n = a.n + 1 \land b.n \neq x\}$}
    ([yshift=0.7em]B.west);
\draw[consistency relation]
    ([xshift=0.7em]A.south)
    --
    node[pos=0, below left] {$a$}
    ++(0,-0.4*\vdistance)
    -|
    node[pos=1, below right] {$c$}
    node[above, pos=0.25] {$\consistencyrelation{CR}{AC} = \setted{\tupled{a,c} \mid a.n = c.n}$}
    ([xshift=-0.7em]C.south);
\draw[consistency relation]
    ([xshift=0.7em]A.north)
    |-
    node[pos=0, above left] {$a$}
    node[pos=1, above left] {$d$}
    node[below, pos=0.75] {$\consistencyrelation{CR}{AD} = \setted{\tupled{a,d} \mid a.n = d.n}$}
    ([yshift=-0.7em]D.west);
\draw[consistency relation]
    ([yshift=0.7em]B.east)
    --
    node[pos=0, below right] {$b$}
    node[pos=1, below left] {$c$}
    node[above, align=center] {$\consistencyrelation{CR}{BC} = \setted{\tupled{b,c} \mid b.n = c.n}$}
    ([yshift=0.7em]C.west);
\draw[consistency relation]
    ([xshift=-0.7em]C.north)
    |-
    node[pos=0, above right] {$c$}
    node[pos=1, above right] {$d$}
    node[below, pos=0.75] {$\consistencyrelation{CR}{CD} = \setted{\tupled{c,d} \mid c.n = d.n}$}
    ([yshift=-0.7em]D.east);

\draw[transformation]
    ([yshift=-0.7em]A.east)
    --
    node[below, align=left] {$+a \xrightarrow{a.n \;\neq \; x-1} +b(n = a.n + 1)$\\
        $+b \xrightarrow{b.n \; \neq \; x} +a(n = b.n - 1)$}
    ([yshift=-0.7em]B.west);
\draw[transformation]
    ([xshift=-0.7em]A.south)
    --
    ++(0,-0.4*\vdistance-1.4em)
    -|
    node[below, pos=0.25, align=left] {$+a \rightarrow +c(n = a.n)$\\
        $+c \rightarrow +a(n = c.n)$}
    ([xshift=0.7em]C.south);
\draw[transformation]
    ([xshift=-0.7em]A.north)
    |-
    node[above, pos=0.75, align=left] {$+a \rightarrow +d(n = a.n)$\\
        $+d \rightarrow +a(n = d.n)$}
    ([yshift=0.7em]D.west);
\draw[transformation]
    ([yshift=-0.7em]B.east)
    --
    node[below, align=left] {$+b \rightarrow +c (n = b.n)$\\
        $+c \rightarrow +b (n = c.n)$}
    ([yshift=-0.7em]C.west);
\draw[transformation]
    ([xshift=0.7em]C.north)
    |-
    node[above, pos=0.75, align=left] {$+c \rightarrow +d(n = c.n)$\\
        $+d \rightarrow +c(n = d.n)$}
    ([yshift=0.7em]D.east);

\end{tikzpicture}