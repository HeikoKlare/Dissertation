%% From motivational_example in MPM4CPS paper

\newcommand{\hdistance}{10.6em}
\newcommand{\classwidth}{6em}

\begin{tikzpicture}

% Person
\umlclassvarwidth{person}{}{Person\sameheight}{
firstname\\
lastname\\
address\\
income
}{\classwidth}

% Employee
\umlclassvarwidth[,above right=3em and \hdistance of person.east, anchor=south]{employee}{}{Employee\sameheight}{
name\\
socsecnumber\\
salary
}{\classwidth}

\umlclassvarwidth[,below=6em of employee.south, anchor=north]{resident}{}{Resident\sameheight}{
name\\
address\\
socsecnumber
}{\classwidth}


% CONSISTENCY RELATIONS
\draw[consistency relation] (person.north) |- node[pos=0, above left] {$p$} node[pos=0.75, above] {$R_{PE}$} node[pos=1, above left] {$e$} (employee.west);
\draw[consistency relation] (employee.south) -- node[pos=0, below right] {$e$} node[right, align=left] {$R_{ER}$}% /\\ $R'_{ER}$} 
node[pos=1, above right] {$r$} (resident.north);
\draw[consistency relation] (resident.west) -| node[pos=0, below left] {$r$} node[pos=0.25, below] {$R_{PR}$} node[pos=1, below left] {$p$} (person.south);

\draw[consistency relation 2] (person.east) -- node[pos=0, below right] {$p$} ++(0.35*\hdistance,0) -- node[pos=0, right=0.5em] {$R_{PER}$} node[pos=1, above left] {$e$} ([yshift=1em]employee.south west);
\draw[consistency relation 2, ->] ([xshift=0.35*\hdistance]person.east) -- node[pos=1, below left] {$r$} ([yshift=-1em]resident.north west);

\node[consistency related element 2, below left=5em and 2.5em of person.south west, anchor=north west] (relations1) {
$\begin{aligned}
    R_{PER} =\; &
            \setted{\tupled{p,e,r} \mid \\
            & p.firstname + "\text{\textvisiblespace}" + p.lastname = e.name = r.name\\
            & \land p.address = r.address%\\
            %& 
            \land p.income = e.salary\\
            & \land e.socsecnumber = r.socsecnumber
        }
\end{aligned}$
};

\node[consistency related element, below=0.5em of relations1.south west, anchor=north west] {
$\begin{aligned}
    R_{PE} =\; &
            \setted{\tupled{p,e} \mid %\\
            %& 
            p.firstname + "\text{\textvisiblespace}" + p.lastname = e.name\\
            & \land p.income = e.salary
        }\\[0.3em]
    R_{PR} =\; &
            \setted{\tupled{p,r} \mid %\\
            %& 
            p.firstname + "\text{\textvisiblespace}" + p.lastname = r.name\\
            & \land p.address = r.address
        }\\[0.3em]
    R_{ER} =\; &
            \setted{\tupled{e,r} \mid %\\
            %& 
            e.name = r.name\\
            & \land e.socsecnumber = r.socsecnumber
        }%\\
    % R'_{ER} =\; &
    %         \setted{\tupled{e,r} \mid %\\
    %         %& 
    %         e.name.toLower = r.name\\
    %         & \land e.socsecnumber = r.socsecnumber
    %     }
\end{aligned}$
};

\end{tikzpicture}